service: auth

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage}
  stackName: art-center-auth-${self:provider.stage}
  environment:
    AUTH0_MANAGEMENT_CLIENT_ID_PARAM_NAME: ${self:custom.auth0.managementClient.id.paramName}
    AUTH0_MANAGEMENT_CLIENT_SECRET_PARAM_NAME: ${self:custom.auth0.managementClient.secret.paramName}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - ssm:GetParameter
      Resource:
        - ${self:custom.auth0.managementClient.id.paramArn}
        - ${self:custom.auth0.managementClient.secret.paramArn}

custom:
  webpack:
    webpackConfig: ./webpack.config.js
    includeModules: true
  auth0:
    managementClient:
      id:
        paramName: "auth0-management-client-id"
        paramArn: "arn:aws:ssm:#{AWS::Region}:#{AWS::AccountId}:parameter/${self:custom.auth0.managementClient.id.paramName}"
      secret:
        paramName: "auth0-management-client-secret"
        paramArn: "arn:aws:ssm:#{AWS::Region}:#{AWS::AccountId}:parameter/${self:custom.auth0.managementClient.secret.paramName}"
  spaClient:
    name: "${self:provider.stackName}-spa-client"
  databaseConnection:
    name: "${self:provider.stackName}-db-connection"
  resourceServer:
    name: "${self:provider.stackName}-resource-server"
    identifier: "https://${self:provider.stackName}.groffcole.com/"
    scopes:
      adminUser: "admin.user.${self:provider.stackName}"
      regularUser: "regular.user.${self:provider.stackName}"

plugins:
  - serverless-webpack
  - serverless-pseudo-parameters

functions:
  spaClientHandler:
    handler: src/service-tokens/spa-client/SpaClientHandler.handle
  databaseConnectionHandler:
    handler: src/service-tokens/database-connection/DatabaseConnectionHandler.handle
  resourceServer:
    handler: src/service-tokens/resource-server/ResourceServerHandler.handle

resources:
  Resources:
    SpaClient:
      Type: AWS::CloudFormation::CustomResource
      Properties:
        ServiceToken:
          Fn::GetAtt: [SpaClientHandlerLambdaFunction, Arn]
        SpaClientName: ${self:custom.spaClient.name}
        Stage: ${self:provider.stage}
        Callbacks:
          - "http://localhost:3000"
        AllowedLogoutUrls:
          - "http://localhost:3000"
        WebOrigins:
          - "http://localhost:3000"
        AllowedOrigins:
          - "http://localhost:3000"

    DatabaseConnection:
      Type: AWS::CloudFormation::CustomResource
      Properties:
        ServiceToken:
          Fn::GetAtt: [DatabaseConnectionHandlerLambdaFunction, Arn]
        DatabaseConnectionName: ${self:custom.databaseConnection.name}
        Stage: ${self:provider.stage}
        SpaClientId:
          Ref: SpaClient

    ResourceServer:
      Type: AWS::CloudFormation::CustomResource
      Properties:
        ServiceToken:
          Fn::GetAtt: [ResourceServerHandlerLambdaFunction, Arn]
        ResourceServerName: ${self:custom.resourceServer.name}
        Stage: ${self:provider.stage}
        Identifier: ${self:custom.resourceServer.identifier}
        Scopes:
          - value: ${self:custom.resourceServer.scopes.adminUser}
            description: ${self:custom.resourceServer.scopes.adminUser}
          - value: ${self:custom.resourceServer.scopes.regularUser}
            description: ${self:custom.resourceServer.scopes.regularUser}